# PonyClaw 功能文档

本文档全面介绍 PonyClaw 的所有功能特性。

## 目录

- [核心特性](#核心特性)
- [AI 智能体能力](#ai-智能体能力)
- [通信渠道](#通信渠道)
- [LLM 提供商支持](#llm-提供商支持)
- [内置工具](#内置工具)
- [高级功能](#高级功能)
- [配置与管理](#配置与管理)

---

## 核心特性

### 1. 轻量级架构
- **Go 语言实现**: 编译型二进制文件，依赖最少
- **低内存占用**: 针对资源受限环境优化
- **快速启动**: 快速初始化和执行
- **跨平台支持**: 支持 x86_64、ARM64、RISC-V 架构

### 2. 多智能体系统
- **智能体注册表**: 管理多个具有不同配置的 AI 智能体
- **上下文管理**: 维护对话上下文和历史记录
- **会话管理**: 处理多个并发对话
- **工作区隔离**: 每个智能体在自己的工作区中运行

### 3. 安全沙箱
- **工作区限制**: 将文件和命令访问限制在配置的工作区内
- **命令过滤**: 阻止危险的系统命令
- **路径验证**: 防止访问敏感系统目录
- **可配置安全性**: 根据需要启用/禁用限制

---

## AI 智能体能力

### 对话管理
- **多轮对话**: 在多次交互中保持上下文
- **会话持久化**: 保存和恢复对话历史
- **记忆系统**: 在 MEMORY.md 中存储长期记忆
- **上下文缓存**: 通过上下文重用优化 LLM API 调用

### 智能体定制
- **身份配置**: 通过 IDENTITY.md 定义智能体个性
- **灵魂/性格**: 通过 SOUL.md 自定义智能体行为
- **用户偏好**: 在 USER.md 中存储用户特定设置
- **智能体行为指南**: 通过 AGENTS.md 配置智能体动作

### 自主操作
- **工具执行**: 自动使用工具完成任务
- **子智能体生成**: 创建子智能体进行并行任务执行
- **异步任务处理**: 长时间运行操作的非阻塞执行
- **错误恢复**: 自动重试和回退机制

---

## 通信渠道

PonyClaw 支持多个聊天平台进行用户交互：

### 即时通讯
- **Telegram**: 完整支持，包括语音转录、内联键盘
- **Discord**: Socket 模式，支持私信和服务器频道
- **Slack**: Socket 模式，企业级就绪
- **WhatsApp**: 通过桥接集成
- **LINE**: 基于 Webhook 的集成

### 企业平台
- **QQ**: 官方机器人 API 支持
- **钉钉 (DingTalk)**: Stream 模式，无需公网 IP
- **飞书 (Feishu)**: 企业协作功能
- **企业微信 (WeCom)**: 
  - Bot 模式（通过 webhook 的群聊）
  - App 模式（带主动消息的私聊）

### 社区协议
- **OneBot**: 兼容 NapCat、Go-CQHTTP 实现

### 渠道特性
- **用户白名单**: 限制特定用户访问
- **消息路由**: 智能消息分发
- **媒体支持**: 处理图片、语音消息、文件
- **异步消息**: 非阻塞消息传递

---

## LLM 提供商支持

### 支持的提供商

PonyClaw 使用以模型为中心的配置，支持多个 LLM 提供商：

#### 商业提供商
- **OpenAI**: GPT-4、GPT-3.5 等模型
- **Anthropic**: Claude 3 系列（Opus、Sonnet、Haiku）
- **Google Gemini**: Gemini Pro 和 Flash 模型
- **DeepSeek**: DeepSeek Chat 和 Coder 模型
- **Groq**: 使用 Llama、Mixtral 模型的快速推理
- **Moonshot**: Moonshot AI 模型
- **Cerebras**: 超快速推理

#### 国内提供商
- **智谱 AI (Zhipu)**: GLM-4 系列模型
- **通义千问 (Qwen)**: 阿里巴巴的 Qwen 模型
- **火山引擎 (Volcengine)**: 字节跳动的 LLM 服务
- **神算云 (Shengsuanyun)**: 国内 LLM 聚合器

#### 聚合器和代理
- **OpenRouter**: 通过单一 API 访问 100+ 模型
- **NVIDIA**: NVIDIA AI Foundation 模型

#### 本地和自托管
- **Ollama**: 本地运行模型
- **VLLM**: 自托管模型服务
- **GitHub Copilot**: 本地 Copilot 集成

#### 特殊集成
- **Antigravity**: 基于 OAuth 的 Google Cloud 集成
- **Claude CLI**: 直接 Claude 桌面应用集成
- **Codex CLI**: OpenAI Codex 集成

### 提供商特性
- **负载均衡**: 在多个端点之间分配请求
- **回退支持**: 自动故障转移到备用提供商
- **OAuth 认证**: 支持提供商的安全认证
- **自定义 API Base**: 使用代理或自定义端点
- **请求超时**: 每个模型可配置超时
- **冷却管理**: 速率限制和重试逻辑

---

## 内置工具

PonyClaw 为 AI 智能体提供了一套全面的工具：

### 文件系统操作
- **read_file**: 读取文件内容
- **write_file**: 创建或覆盖文件
- **edit_file**: 修改现有文件
- **append_file**: 向文件追加内容
- **list_dir**: 列出目录内容

### 命令执行
- **exec**: 执行 shell 命令
  - 超时支持
  - 工作目录控制
  - 环境变量管理
  - 针对危险命令的安全防护

### 网络和搜索
- **web_search**: 搜索互联网
  - Brave Search API
  - DuckDuckGo（无需 API 密钥）
  - Perplexity API
  - Tavily API（AI 优化）
- **web_fetch**: 从 URL 获取内容
  - HTML 解析
  - 内容提取
  - 媒体下载支持

### 任务管理
- **cron**: 安排任务和提醒
  - 一次性提醒
  - 重复任务
  - Cron 表达式支持
  - 任务持久化

### 智能体操作
- **spawn**: 为异步任务创建子智能体
  - 独立上下文
  - 并行执行
  - 结果回调支持
- **subagent**: 将任务委托给专门的智能体
  - 任务隔离
  - 资源管理
- **message**: 向用户发送消息
  - 多渠道支持
  - 异步传递

### 技能和扩展
- **find_skills**: 搜索可用技能
  - ClawHub 注册表集成
  - 本地技能发现
- **install_skill**: 安装新技能
  - 自动依赖解析
  - 技能验证

### 硬件集成（Linux）
- **i2c**: I2C 设备通信
  - 读/写操作
  - 设备扫描
- **spi**: SPI 设备通信
  - 数据传输
  - 设备控制

### 工具特性
- **异步执行**: 非阻塞工具调用
- **错误处理**: 优雅的错误恢复
- **结果格式化**: 为 LLM 消费的结构化输出
- **上下文感知**: 工具可以访问渠道/聊天上下文
- **可扩展性**: 易于添加自定义工具

---

## 高级功能

### 1. 心跳系统
无需用户干预的周期性任务执行：
- **可配置间隔**: 默认 30 分钟，最小 5 分钟
- **任务定义**: 在 HEARTBEAT.md 中定义任务
- **异步任务支持**: 使用 spawn 处理长时间运行的任务
- **工具访问**: 完全访问所有智能体工具
- **启用/禁用**: 通过配置切换

### 2. 技能系统
使用自定义技能扩展智能体能力：
- **技能注册表**: 从 ClawHub 和本地源发现技能
- **技能安装**: 自动下载和设置
- **技能加载**: 运行时动态技能加载
- **技能隔离**: 每个技能在隔离的上下文中运行
- **技能搜索**: 按关键字或类别查找技能

### 3. 语音转录
将语音消息转换为文本：
- **Groq Whisper**: 通过 Groq API 免费语音转录
- **Telegram 集成**: 自动语音消息转录
- **多语言支持**: 支持多种语言

### 4. OAuth 认证
支持提供商的安全认证：
- **PKCE 流程**: 带 PKCE 的安全 OAuth 2.0
- **令牌管理**: 自动令牌刷新
- **提供商支持**: Anthropic、Google Gemini
- **凭证存储**: 安全的本地存储

### 5. 设备监控
监控和响应硬件事件：
- **USB 设备检测**: 检测 USB 设备连接
- **事件触发器**: 在设备事件上执行操作
- **设备信息**: 查询设备详细信息

### 6. 消息总线
组件通信的内部事件系统：
- **入站消息**: 来自渠道的用户消息
- **出站消息**: 智能体对渠道的响应
- **事件广播**: 系统范围的事件分发
- **异步处理**: 非阻塞消息处理

### 7. 迁移系统
自动配置和工作区迁移：
- **配置迁移**: 更新旧配置格式
- **工作区迁移**: 升级工作区结构
- **向后兼容**: 支持旧版配置

---

## 配置与管理

### 配置文件
- **config.json**: 主配置文件
- **工作区文件**: 智能体特定配置
  - IDENTITY.md: 智能体身份
  - SOUL.md: 智能体性格
  - USER.md: 用户偏好
  - AGENTS.md: 智能体行为
  - HEARTBEAT.md: 周期性任务
  - MEMORY.md: 长期记忆
  - TOOLS.md: 工具描述

### CLI 命令
- **onboard**: 初始化配置和工作区
- **agent**: 交互式智能体模式
- **gateway**: 启动多渠道网关
- **status**: 显示系统状态
- **auth**: 管理 OAuth 认证
- **cron**: 管理计划任务
- **skills**: 管理技能
- **migrate**: 运行迁移

### 环境变量
通过环境变量覆盖配置：
- `PONYCLAW_*`: 所有配置选项都可以通过环境变量设置
- `PONYCLAW_HEARTBEAT_ENABLED`: 启用/禁用心跳
- `PONYCLAW_HEARTBEAT_INTERVAL`: 设置心跳间隔
- `PONYCLAW_GATEWAY_HOST`: 网关监听地址
- `PONYCLAW_GATEWAY_PORT`: 网关监听端口

### 日志记录
- **结构化日志**: JSON 格式的日志
- **日志级别**: Debug、Info、Warn、Error
- **上下文字段**: 丰富的上下文信息
- **组件标记**: 识别日志源

### 健康监控
- **健康端点**: HTTP 健康检查端点
- **状态 API**: 查询系统状态
- **渠道状态**: 监控渠道健康
- **智能体状态**: 跟踪智能体活动

---

## Docker 支持

### Docker Compose
- **网关模式**: 作为多渠道网关运行
- **智能体模式**: 一次性智能体执行
- **卷挂载**: 持久化配置和数据
- **网络配置**: 根据需要暴露端口

### 容器特性
- **多架构**: 支持 amd64、arm64
- **最小镜像**: 小容器大小
- **健康检查**: 内置健康监控
- **环境配置**: 通过环境变量配置

---

## 性能特性

### 优化
- **上下文缓存**: 降低 LLM API 成本
- **连接池**: 重用 HTTP 连接
- **并发处理**: 同时处理多个请求
- **内存管理**: 高效的内存使用

### 可靠性
- **自动重试**: 重试失败的操作
- **错误恢复**: 优雅的错误处理
- **回退机制**: 备用提供商和策略
- **速率限制**: 遵守 API 速率限制

### 监控
- **执行计时**: 跟踪工具执行时间
- **令牌使用**: 监控 LLM 令牌消耗
- **错误跟踪**: 记录和跟踪错误
- **性能指标**: 系统性能数据

---

## 安全特性

### 访问控制
- **用户白名单**: 每个渠道限制访问
- **工作区隔离**: 沙箱文件系统访问
- **命令过滤**: 阻止危险命令
- **路径验证**: 防止目录遍历

### 数据保护
- **凭证存储**: 安全的 API 密钥存储
- **会话加密**: 保护会话数据
- **安全通信**: 渠道使用 HTTPS/WSS
- **令牌管理**: 安全的 OAuth 令牌处理

### 安全防护
- **命令黑名单**: 阻止破坏性命令
- **路径限制**: 限制文件系统访问
- **资源限制**: 防止资源耗尽
- **超时保护**: 防止无限循环

---

## 可扩展性

### 自定义工具
- **工具接口**: 简单的工具创建 API
- **工具注册**: 动态工具注册
- **工具发现**: 自动工具检测
- **工具文档**: 自文档化工具

### 自定义渠道
- **渠道接口**: 标准渠道 API
- **渠道注册**: 动态渠道注册
- **消息路由**: 自动消息路由
- **事件处理**: 标准事件处理

### 自定义提供商
- **提供商接口**: 标准提供商 API
- **提供商工厂**: 动态提供商创建
- **协议支持**: 多协议支持
- **错误处理**: 标准错误处理

### 插件系统
- **技能插件**: 使用自定义技能扩展
- **工具插件**: 添加自定义工具
- **提供商插件**: 添加自定义 LLM 提供商
- **渠道插件**: 添加自定义通信渠道

---

## 未来功能（路线图）

查看 [ROADMAP.md](ROADMAP.md) 了解计划的功能和开发优先级。

---

## 获取帮助

- **文档**: 查看 README.md 和 docs/ 目录
- **问题**: 在 GitHub Issues 上报告错误
- **讨论**: 在 GitHub Discussions 上提问
- **贡献**: 查看 CONTRIBUTING.md 了解贡献指南
